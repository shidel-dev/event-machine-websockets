<!doctype html>
<html>
  <head>
  </head>
  <body>

      # WebSockets Chat App
      <div id="chat-log">

        <input type="text" id="message">
        <button id="disconnect">Disconnect</button>
        <input type="text" id="friend" placeholder='target'>
        

        <%unless $clients.empty?%>
          <%$clients.each do |client|%>
        	  <p><%=client[:user]%></p>
          <%end%>	
        <%end%>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>
			function addMessage(msg) {
			  $("#chat-log").append("<p>" + msg + "</p>");
			}
			var socket, host, id;
			host = "ws://<%=request.host%>:3001";

			function connect() {
			  try {
			    socket = new WebSocket(host);

			    addMessage("Socket State: " + socket.readyState);

			    socket.onopen = function() {
			      addMessage("Socket Status: " + socket.readyState + " (open)");
			    }

			    socket.onclose = function() {
			      addMessage("Socket Status: " + socket.readyState + " (closed)");
			    }

			    socket.onmessage = function(msg) {
			    	console.log(msg.data.split(":"))
			    	if (msg.data.split(":")[0] == "id"){
			    		id = msg.data.split(":")[1];
			    	}

			      addMessage("Received: " + msg.data);
			    }
			  } catch(exception) {
			    addMessage("Error: " + exception);
			  }
			}

			$(function() {
			  connect();
			});
			function send() {
			  var text = $("#message").val();
			  var friend = $("#friend").val();
			  if (text == '') {
			    addMessage("Please Enter a Message");
			    return;
			  }

			  try {
			    socket.send(id+','+text+','+friend);
			    addMessage("Sent: " + text)
			  } catch(exception) {
			    addMessage("Failed To Send")
			  }

			  $("#message").val('');
			}

			$('#message').keypress(function(event) {
			  if (event.keyCode == '13') { send(); }
			});
			$("#disconnect").click(function() {
  				socket.close()
				});
			
    </script>
  </body>
</html>